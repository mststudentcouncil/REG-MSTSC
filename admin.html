<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - REG MSTSC</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #6A1B9A;
            --secondary-color: #FFD600;
            --bg-color: #f3f0f7;
        }

        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: var(--bg-color); 
            padding-bottom: 60px; 
        }

        .global-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            text-align: center; padding: 15px; font-size: 0.75rem;
            color: #6c757d; opacity: 0.8; z-index: 10000;
            pointer-events: none;
        }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #6A1B9A 0%, #311b92 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .admin-nav { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .admin-nav .logo { height: 40px; margin-right: 10px; border-radius: 50%; border: 2px solid var(--secondary-color); }
        .container-fluid { max-width: 1800px; padding: 30px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .bg-active { background-color: #d1e7dd; color: #0f5132; }
        .bg-inactive { background-color: #f8d7da; color: #842029; }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(106, 27, 154, 0.25); }

        .custom-search { position: relative; margin-bottom: 20px; }
        .custom-search input { padding-left: 45px; border-radius: 30px; height: 50px; font-size: 1.1rem; border: 2px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .custom-search input:focus { border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(106, 27, 154, 0.15); }
        .custom-search i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 1.2rem; }
        .dataTables_filter { display: none; }

        .view-row { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; }
        .view-label { width: 35%; font-weight: 600; color: #666; }
        .view-val { width: 65%; color: #333; font-weight: 500; }
        .modal-header-view { background: linear-gradient(135deg, #17a2b8, #117a8b); color: white; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="https://i.postimg.cc/yxjxZmRN/Logo-mstsc-(1)-(1).png" width="90" class="mb-3 rounded-circle border border-warning border-3">
            <h4 class="fw-bold text-dark mb-3">ADMIN REG - MSTSC</h4>
            <form onsubmit="handleAdminLogin(event)">
                <input type="email" id="loginEmail" class="form-control mb-3" placeholder="admin@mst.ac.th" required>
                <input type="password" id="loginPass" class="form-control mb-4" placeholder="Password" required>
                <button type="submit" class="btn btn-warning w-100 fw-bold shadow-sm mb-3">เข้าสู่ระบบ</button>
            </form>
            <a href="index.html" class="btn btn-link text-decoration-none text-muted small">
                <i class="fa-solid fa-arrow-left"></i> ย้อนกลับหน้าหลัก
            </a>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <nav class="navbar admin-nav px-4 py-3">
            <div class="d-flex align-items-center">
                <img src="https://i.postimg.cc/yxjxZmRN/Logo-mstsc-(1)-(1).png" class="logo">
                <div>
                    <div class="fw-bold fs-5">ระบบจัดการข้อมูลคณะกรรมการสภานักเรียนโรงเรียนเมืองสุราษฎร์ธานี</div>
                    <small class="text-warning opacity-75">Admin Mode</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-light text-primary fw-bold rounded-pill px-3 shadow-sm">
                    <i class="fa-solid fa-house"></i> หน้าหลัก
                </a>
                <button class="btn btn-warning fw-bold shadow-sm" onclick="openImportModal()">
                    <i class="fa-solid fa-file-csv"></i> นำเข้า
                </button>
                <button class="btn btn-outline-light rounded-pill px-4" onclick="adminLogout()">
                    <i class="fa-solid fa-sign-out-alt"></i> ออก
                </button>
            </div>
        </nav>

        <div class="container-fluid">
            
            <div class="alert alert-danger border-danger shadow-sm d-flex align-items-center mb-4" role="alert">
                <i class="fa-solid fa-shield-halved fs-2 me-3"></i>
                <div>
                    <strong class="fs-5">คำเตือน: ข้อมูลส่วนบุคคล (PDPA)</strong><br>
                    ข้อมูลในระบบนี้เป็นข้อมูลส่วนบุคคลที่มีความละเอียดอ่อน ห้ามคัดลอก เผยแพร่ หรือส่งต่อแก่บุคคลภายนอกโดยไม่ได้รับอนุญาต <br>
                    กรุณาใช้งานเพื่อการบริหารงานของสภานักเรียนโรงเรียนเมืองสุราษฎร์ธานีเท่านั้น
                </div>
            </div>

            <div class="card border-0 shadow-sm p-4 rounded-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold text-primary m-0"><i class="fa-solid fa-database"></i> ฐานข้อมูลนักเรียน</h5>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="location.reload()">
                        <i class="fa-solid fa-sync"></i> รีเฟรช
                    </button>
                </div>

                <div class="custom-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="ค้นหาด้วย ชื่อ, นามสกุล หรือชื่อเล่น...">
                </div>

                <div class="table-responsive">
                    <table id="studentTable" class="table table-hover w-100 fs-6">
                        <thead class="bg-light text-primary">
                            <tr>
                                <th>ปีการศึกษา</th> 
                                <th>รหัส</th>
                                <th>บัตร ปชช.</th>
                                <th>ชื่อ-สกุล (ไทย)</th>
                                <th>ชื่อเล่น</th>
                                <th>ห้อง</th>
                                <th>อีเมล</th>
                                <th>เบอร์โทร</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                                <th class="d-none">ชื่อ (Eng)</th><th class="d-none">วันเกิด</th><th class="d-none">เลือด</th><th class="d-none">เสื้อ</th>
                                <th class="d-none">เมลส่วนตัว</th><th class="d-none">Line</th><th class="d-none">Social</th><th class="d-none">ที่อยู่</th>
                                <th class="d-none">ผู้ปกครอง</th><th class="d-none">เบอร์ผู้ปกครอง</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="global-footer">
        © 2026 Student Council, Muangsuratthani School.<br>
        Powered by Information Technology Team
    </div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-file-import"></i> นำเข้าข้อมูล</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="bg-light p-3 rounded mb-3 border">
                        <label class="fw-bold text-primary mb-2"><i class="fa-solid fa-calendar-check"></i> เลือกปีการศึกษา:</label>
                        <input type="number" id="importYear" class="form-control fw-bold fs-5 text-center text-primary" style="max-width: 200px;">
                    </div>
                    <div class="alert alert-info small">
                        <b>วิธีใช้งาน:</b> ก๊อปปี้จาก Excel หรือ Google Sheet 2 คอลัมน์ <code>[รหัสนักเรียน]</code> และ <code>[ชื่อ-สกุล]</code><br>
                        *ระบบจะแยกคำนำหน้าชื่อ และข้ามคนที่รหัสซ้ำให้อัตโนมัติ
                    </div>
                    <textarea id="importData" class="form-control font-monospace" rows="10" placeholder="12345  นายสภา น่ารัก"></textarea>
                    <div class="mt-2 text-end text-muted small" id="lineCount">0 รายการ</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary px-4" onclick="processImport()">ตรวจสอบและบันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-user-pen"></i> แก้ไขข้อมูลนักเรียน (แก้ไขได้ทุกช่อง)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="fullEditForm" onsubmit="saveFullEdit(event)">
                        <input type="hidden" id="e_id">
                        
                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">1. ข้อมูลหลัก</h6>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="small text-danger fw-bold">ปีการศึกษา (Admin)</label><input type="number" id="e_academic_year" class="form-control fw-bold text-primary"></div>
                                <div class="col-md-3"><label class="small text-muted">รหัสนักเรียน</label><input type="text" id="e_std_id" class="form-control fw-bold" required></div>
                                <div class="col-md-3"><label class="small text-muted">เลขบัตรปชช.</label><input type="text" id="e_id_card" class="form-control text-primary" maxlength="13"></div>
                                <div class="col-md-3"><label class="small text-muted">คำนำหน้า</label><input type="text" id="e_prefix" class="form-control"></div>
                                <div class="col-md-6"><label class="small text-muted">ชื่อ (ไทย)</label><input type="text" id="e_fname_th" class="form-control" required></div>
                                <div class="col-md-6"><label class="small text-muted">นามสกุล (ไทย)</label><input type="text" id="e_lname_th" class="form-control" required></div>
                            </div>
                        </div>

                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">2. ข้อมูลส่วนตัว</h6>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="small">Name (En)</label><input type="text" id="e_fname_en" class="form-control uppercase"></div>
                                <div class="col-md-3"><label class="small">Surname (En)</label><input type="text" id="e_lname_en" class="form-control uppercase"></div>
                                <div class="col-md-2"><label class="small">ชื่อเล่น</label><input type="text" id="e_nickname" class="form-control"></div>
                                <div class="col-md-2"><label class="small">ห้อง</label><input type="text" id="e_room" class="form-control"></div>
                                <div class="col-md-2"><label class="small">วันเกิด (ISO)</label><input type="date" id="e_birthdate" class="form-control"></div>
                                <div class="col-md-2"><label class="small">กรุ๊ปเลือด</label><input type="text" id="e_blood" class="form-control"></div>
                                <div class="col-md-2"><label class="small">ไซส์เสื้อ</label><input type="text" id="e_shirt" class="form-control"></div>
                            </div>
                        </div>

                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">3. การติดต่อ & ที่อยู่</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="small text-danger fw-bold">อีเมลโรงเรียน (@mst.ac.th)</label><input type="text" id="e_school_email" class="form-control"></div>
                                <div class="col-md-4"><label class="small">อีเมลส่วนตัว</label><input type="text" id="e_personal_email" class="form-control"></div>
                                <div class="col-md-4"><label class="small">เบอร์โทรศัพท์</label><input type="text" id="e_phone" class="form-control"></div>
                                <div class="col-md-4"><label class="small">Line ID</label><input type="text" id="e_line" class="form-control"></div>
                                <div class="col-md-8"><label class="small">Social</label><input type="text" id="e_social" class="form-control"></div>
                                <div class="col-12 mt-3"><label class="small fw-bold">ที่อยู่ (บ้านเลขที่ หมู่ ซอย ถนน)</label><input type="text" id="e_addr_no" class="form-control"></div>
                                <div class="col-md-3"><label class="small">ตำบล/แขวง</label><input type="text" id="e_district" class="form-control"></div>
                                <div class="col-md-3"><label class="small">อำเภอ/เขต</label><input type="text" id="e_amphoe" class="form-control"></div>
                                <div class="col-md-3"><label class="small">จังหวัด</label><input type="text" id="e_province" class="form-control"></div>
                                <div class="col-md-3"><label class="small">รหัสไปรษณีย์</label><input type="text" id="e_zipcode" class="form-control"></div>
                            </div>
                        </div>

                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">4. ข้อมูลผู้ปกครอง</h6>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="small">ชื่อ-สกุล ผู้ปกครอง</label><input type="text" id="e_parent_name" class="form-control"></div>
                                <div class="col-md-6"><label class="small">เบอร์โทรผู้ปกครอง</label><input type="text" id="e_parent_phone" class="form-control"></div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">ยกเลิก</button>
                            <button type="submit" class="btn btn-primary px-4 py-2"><i class="fa-solid fa-save"></i> บันทึกการแก้ไขทั้งหมด</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-view">
                    <h5 class="modal-title"><i class="fa-solid fa-address-card"></i> ข้อมูลนักเรียนโดยละเอียด</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="view-row"><div class="view-label">รหัสนักเรียน:</div><div class="view-val" id="v_std_id"></div></div>
                            <div class="view-row"><div class="view-label">ปีการศึกษา:</div><div class="view-val" id="v_academic_year"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อ-สกุล (ไทย):</div><div class="view-val" id="v_name_th"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อ-สกุล (Eng):</div><div class="view-val" id="v_name_en"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อเล่น:</div><div class="view-val" id="v_nickname"></div></div>
                            <div class="view-row"><div class="view-label">เลขบัตร ปชช.:</div><div class="view-val" id="v_id_card"></div></div>
                            <div class="view-row"><div class="view-label">วันเกิด:</div><div class="view-val" id="v_birthdate"></div></div>
                            <div class="view-row"><div class="view-label">กรุ๊ปเลือด:</div><div class="view-val" id="v_blood"></div></div>
                            <div class="view-row"><div class="view-label">ไซส์เสื้อ:</div><div class="view-val" id="v_shirt"></div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="view-row"><div class="view-label">ห้อง:</div><div class="view-val" id="v_room"></div></div>
                            <div class="view-row"><div class="view-label">เบอร์โทร:</div><div class="view-val" id="v_phone"></div></div>
                            <div class="view-row"><div class="view-label">Email โรงเรียน:</div><div class="view-val" id="v_school_email"></div></div>
                            <div class="view-row"><div class="view-label">Email ส่วนตัว:</div><div class="view-val" id="v_personal_email"></div></div>
                            <div class="view-row"><div class="view-label">Line ID:</div><div class="view-val" id="v_line"></div></div>
                            <div class="view-row"><div class="view-label">Social:</div><div class="view-val" id="v_social"></div></div>
                            <div class="view-row"><div class="view-label">ที่อยู่:</div><div class="view-val" id="v_address"></div></div>
                            <div class="view-row"><div class="view-label">ผู้ปกครอง:</div><div class="view-val" id="v_parent_name"></div></div>
                            <div class="view-row"><div class="view-label">เบอร์ผู้ปกครอง:</div><div class="view-val" id="v_parent_phone"></div></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // CONFIG
        const { createClient } = supabase;
        const supabaseUrl = 'https://llbazqwparjaptsjbxxp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsYmF6cXdwYXJqYXB0c2pieHhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDk0MDQsImV4cCI6MjA4NDU4NTQwNH0.NcHwvFMnzU6GgHBaud4nNJgwFBK1WQtxAdGbcM-BaYU';
        const db = createClient(supabaseUrl, supabaseKey);

        const ADMIN_EMAIL = 'studentcouncil@mst.ac.th';
        const ADMIN_PASS = '077285686';

        // AUTH
        $(document).ready(() => {
            if(localStorage.getItem('mst_admin_session') === 'true') showDashboard();
            else $('#login-overlay').show();
        });

        function handleAdminLogin(e) {
            e.preventDefault();
            if($('#loginEmail').val().trim() === ADMIN_EMAIL && $('#loginPass').val().trim() === ADMIN_PASS) {
                localStorage.setItem('mst_admin_session', 'true');
                showDashboard();
            } else Swal.fire('ผิดพลาด', 'ข้อมูลล็อกอินไม่ถูกต้อง', 'error');
        }

        function showDashboard() {
            $('#login-overlay').fadeOut();
            $('#admin-content').fadeIn();
            initTable();
        }

        function adminLogout() {
            localStorage.removeItem('mst_admin_session');
            location.reload();
        }

        // TABLE
        let table;
        async function initTable() {
            if ($.fn.DataTable.isDataTable('#studentTable')) return;
            const { data, error } = await db.from('student_council').select('*').order('std_id', { ascending: true });
            if(error) return console.error(error);

            table = $('#studentTable').DataTable({
                data: data,
                columns: [
                    { data: 'academic_year', render: d => d ? `<span class="badge bg-secondary">${d}</span>` : '-' },
                    { data: 'std_id' },
                    { data: 'id_card', defaultContent: '-' },
                    { data: null, render: d => `${d.prefix||''} ${d.fname_th} ${d.lname_th}` },
                    { data: 'nickname', defaultContent: '-' },
                    { data: 'room', render: d => d ? `ห้อง ${d}` : '-' },
                    { data: 'school_email', defaultContent: '-' },
                    { data: 'phone', defaultContent: '-' },
                    { data: 'id_card', render: d => (d && d.length>5) ? '<span class="status-badge bg-active">Active</span>':'<span class="status-badge bg-inactive">New</span>' },
                    {
                        data: null, className: "text-center",
                        render: (d, t, r) => {
                            const row = encodeURIComponent(JSON.stringify(r));
                            return `
                                <button class="btn btn-info btn-sm text-white" onclick="openView('${row}')" title="ดูข้อมูลละเอียด"><i class="fa-solid fa-magnifying-glass"></i></button>
                                <button class="btn btn-warning btn-sm" onclick="openEdit('${row}')" title="แก้ไข"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteStudent('${r.id}')" title="ลบ"><i class="fa-solid fa-trash"></i></button>
                            `;
                        }
                    },
                    { data: null, visible: false, render: d => `${d.fname_en} ${d.lname_en}` },
                    { data: 'birthdate', visible: false }, { data: 'blood_type', visible: false },
                    { data: 'shirt_size', visible: false }, { data: 'personal_email', visible: false },
                    { data: 'line_id', visible: false }, { data: 'social', visible: false },
                    { data: 'addr_no', visible: false }, { data: 'parent_name', visible: false },
                    { data: 'parent_phone', visible: false }
                ],
                dom: 'Brtip',
                buttons: [{ extend: 'excelHtml5', text: '<i class="fa-solid fa-file-excel"></i> Export All', className: 'btn btn-success mb-3', exportOptions: { columns: ':visible, :hidden' }}],
                pageLength: 20
            });

            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
        }

        // IMPORT
        function openImportModal() {
            const today = new Date();
            let defaultYear = today.getFullYear() + 543;
            if (today.getMonth() < 4 || (today.getMonth() === 4 && today.getDate() < 15)) defaultYear -= 1;
            $('#importYear').val(defaultYear);
            new bootstrap.Modal('#importModal').show();
        }

        $('#importData').on('input', function() { $('#lineCount').text($(this).val().trim().split('\n').filter(l=>l.trim()).length + ' รายการ'); });

        function splitThaiName(fullName) {
            fullName = fullName.trim();
            const prefixes = ["นางสาว", "นาง", "นาย", "ด.ช.", "ด.ญ.", "ว่าที่ร้อยตรี", "น.ส.", "น.ส", "เด็กชาย", "เด็กหญิง"];
            let prefix = "", fname = "", lname = "";
            for (let p of prefixes) {
                if (fullName.startsWith(p)) {
                    prefix = (p === "น.ส." || p === "น.ส") ? "นางสาว" : p;
                    fullName = fullName.substring(p.length).trim();
                    break;
                }
            }
            const parts = fullName.split(/\s+/);
            if (parts.length > 0) fname = parts[0];
            if (parts.length > 1) lname = parts.slice(1).join(" ");
            return { prefix, fname, lname };
        }

        async function processImport() {
            const raw = $('#importData').val().trim();
            const selectedYear = $('#importYear').val();
            if(!selectedYear) return Swal.fire('ระบุปี', 'กรุณาระบุปีการศึกษา', 'warning');
            if(!raw) return Swal.fire('ข้อมูลว่าง', 'กรุณาวางข้อมูลนักเรียน', 'warning');

            const lines = raw.split('\n');
            const candidates = []; const candidateIds = [];
            lines.forEach(line => {
                const parts = line.split('\t');
                if(parts.length >= 2) {
                    const stdId = parts[0].trim();
                    const nameObj = splitThaiName(parts[1].trim());
                    if(stdId && nameObj.fname) {
                        candidates.push({ std_id: stdId, prefix: nameObj.prefix, fname_th: nameObj.fname, lname_th: nameObj.lname, academic_year: selectedYear });
                        candidateIds.push(stdId);
                    }
                }
            });

            if(candidates.length === 0) return Swal.fire('Format ผิด', 'ตรวจสอบข้อมูล (รหัส [Tab] ชื่อสกุล)', 'error');
            Swal.fire({ title: 'ตรวจสอบ...', didOpen: () => Swal.showLoading() });

            const { data: existingRecords } = await db.from('student_council').select('std_id').in('std_id', candidateIds);
            const existingSet = new Set(existingRecords.map(r => r.std_id));
            const finalInsert = candidates.filter(c => !existingSet.has(c.std_id));
            const skippedCount = candidates.length - finalInsert.length;

            if (finalInsert.length === 0) return Swal.fire('ข้อมูลซ้ำ', 'ไม่พบข้อมูลใหม่', 'info');

            const confirm = await Swal.fire({ title: `ยืนยันนำเข้า`, html: `ปีการศึกษา: <b>${selectedYear}</b><br>ใหม่: ${finalInsert.length}<br>ซ้ำ: ${skippedCount}`, icon: 'question', showCancelButton: true, confirmButtonText: 'ยืนยัน' });
            if (!confirm.isConfirmed) return;

            const { error: insertError } = await db.from('student_council').insert(finalInsert);
            if(insertError) Swal.fire('บันทึกไม่สำเร็จ', insertError.message, 'error');
            else { Swal.fire('สำเร็จ', `บันทึก ${finalInsert.length} รายการ`, 'success'); $('#importModal').modal('hide'); location.reload(); }
        }

        // VIEW DETAIL
        window.openView = function(encodedRow) {
            const r = JSON.parse(decodeURIComponent(encodedRow));
            $('#v_std_id').text(r.std_id || '-');
            $('#v_academic_year').text(r.academic_year || '-');
            $('#v_name_th').text(`${r.prefix || ''} ${r.fname_th} ${r.lname_th}`);
            $('#v_name_en').text(`${r.fname_en || ''} ${r.lname_en || ''}`);
            $('#v_nickname').text(r.nickname || '-');
            $('#v_id_card').text(r.id_card || '-');
            $('#v_birthdate').text(r.birthdate || '-');
            $('#v_blood').text(r.blood_type || '-');
            $('#v_shirt').text(r.shirt_size || '-');
            $('#v_room').text(r.room ? `ห้อง ${r.room}` : '-');
            $('#v_phone').text(r.phone || '-');
            $('#v_school_email').text(r.school_email || '-');
            $('#v_personal_email').text(r.personal_email || '-');
            $('#v_line').text(r.line_id || '-');
            $('#v_social').text(r.social || '-');
            $('#v_address').text(`${r.addr_no||''} ${r.district||''} ${r.amphoe||''} ${r.province||''} ${r.zipcode||''}`);
            $('#v_parent_name').text(r.parent_name || '-');
            $('#v_parent_phone').text(r.parent_phone || '-');
            new bootstrap.Modal('#viewModal').show();
        }

        // EDIT & DELETE
        window.openEdit = function(encodedRow) {
            const r = JSON.parse(decodeURIComponent(encodedRow));
            $('#e_id').val(r.id); $('#e_academic_year').val(r.academic_year); 
            $('#e_std_id').val(r.std_id); $('#e_id_card').val(r.id_card);
            $('#e_prefix').val(r.prefix); $('#e_fname_th').val(r.fname_th); $('#e_lname_th').val(r.lname_th);
            $('#e_fname_en').val(r.fname_en); $('#e_lname_en').val(r.lname_en); $('#e_nickname').val(r.nickname);
            $('#e_room').val(r.room); $('#e_birthdate').val(r.birthdate); $('#e_blood').val(r.blood_type); $('#e_shirt').val(r.shirt_size);
            $('#e_school_email').val(r.school_email); $('#e_personal_email').val(r.personal_email);
            $('#e_phone').val(r.phone); $('#e_line').val(r.line_id); $('#e_social').val(r.social);
            $('#e_addr_no').val(r.addr_no); $('#e_district').val(r.district); $('#e_amphoe').val(r.amphoe);
            $('#e_province').val(r.province); $('#e_zipcode').val(r.zipcode);
            $('#e_parent_name').val(r.parent_name); $('#e_parent_phone').val(r.parent_phone);
            new bootstrap.Modal('#editModal').show();
        }

        async function saveFullEdit(e) {
            e.preventDefault();
            const id = $('#e_id').val();
            const updateObj = {
                academic_year: $('#e_academic_year').val(), std_id: $('#e_std_id').val(), id_card: $('#e_id_card').val(),
                prefix: $('#e_prefix').val(), fname_th: $('#e_fname_th').val(), lname_th: $('#e_lname_th').val(),
                fname_en: $('#e_fname_en').val().toUpperCase(), lname_en: $('#e_lname_en').val().toUpperCase(),
                nickname: $('#e_nickname').val(), room: $('#e_room').val(), birthdate: $('#e_birthdate').val(),
                blood_type: $('#e_blood').val(), shirt_size: $('#e_shirt').val(),
                school_email: $('#e_school_email').val(), personal_email: $('#e_personal_email').val(),
                phone: $('#e_phone').val(), line_id: $('#e_line').val(), social: $('#e_social').val(),
                addr_no: $('#e_addr_no').val(), district: $('#e_district').val(), amphoe: $('#e_amphoe').val(),
                province: $('#e_province').val(), zipcode: $('#e_zipcode').val(),
                parent_name: $('#e_parent_name').val(), parent_phone: $('#e_parent_phone').val()
            };
            const { error } = await db.from('student_council').update(updateObj).eq('id', id);
            if(error) Swal.fire('Error', error.message, 'error');
            else { Swal.fire('Saved', 'บันทึกสำเร็จ', 'success'); location.reload(); }
        }

        window.deleteStudent = async function(id) {
            const res = await Swal.fire({title:'ยืนยันลบ?', text:'ข้อมูลจะหายไปถาวร', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'ลบเลย'});
            if(res.isConfirmed) {
                const { error } = await db.from('student_council').delete().eq('id', id);
                if(error) Swal.fire('ลบไม่ได้', 'ตรวจสอบ Policy', 'error');
                else { Swal.fire('เรียบร้อย', 'ลบแล้ว', 'success'); setTimeout(() => location.reload(), 1000); }
            }
        }
    </script>
</body>
</html>