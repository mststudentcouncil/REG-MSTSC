<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - REG MSTSC</title>
    
    <link rel="icon" type="image/png" href="https://i.postimg.cc/yxjxZmRN/Logo-mstsc-(1)-(1).png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-color: #6A1B9A; --secondary-color: #FFD600; --bg-color: #f3f0f7; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-color); padding-bottom: 60px; }

        /* Z-Index Fixes */
.swal2-container { z-index: 30000 !important; } 
.modal-backdrop { z-index: 1040 !important; }
.modal { z-index: 1050 !important; }

/* เพิ่มบรรทัดนี้เพื่อความชัวร์ */
.swal2-input {
    z-index: 30001 !important;
}
        

        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #6A1B9A 0%, #311b92 100%); 
            display: flex; align-items: center; justify-content: center; 
            z-index: 9999; 
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        .btn-google { background-color: #fff; border: 1px solid #ddd; color: #333; position: relative; transition: all 0.3s; }
        .btn-google:hover { background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-google img { width: 20px; margin-right: 10px; }

        .global-footer { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 15px; font-size: 0.75rem; color: #6c757d; opacity: 0.8; z-index: 10000; pointer-events: none; }
        .admin-nav { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .admin-nav .logo { height: 40px; margin-right: 10px; border-radius: 50%; border: 2px solid var(--secondary-color); }
        .container-fluid { max-width: 1800px; padding: 30px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .bg-active { background-color: #d1e7dd; color: #0f5132; }
        .bg-inactive { background-color: #f8d7da; color: #842029; }
        
        .custom-search { position: relative; margin-bottom: 20px; }
        .custom-search input { padding-left: 45px; border-radius: 30px; height: 50px; font-size: 1.1rem; border: 2px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .custom-search input:focus { border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(106, 27, 154, 0.15); }
        .custom-search i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 1.2rem; }
        .dataTables_filter { display: none; }
        
        .dataTables_length select { border-radius: 20px; padding: 5px 30px 5px 15px; border: 1px solid #ddd; }
        .dataTables_length { margin-bottom: 15px; }

        .view-row { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; }
        .view-label { width: 35%; font-weight: 600; color: #666; }
        .view-val { width: 65%; color: #333; font-weight: 500; }
        .modal-header-view { background: linear-gradient(135deg, #17a2b8, #117a8b); color: white; }

        @media (max-width: 767.98px) {
            .container-fluid { padding: 15px; }
            .admin-nav .logo { height: 35px; }
        }
        /* สำหรับหน้าจอมือถือ (กว้างไม่เกิน 768px) */
@media screen and (max-width: 768px) {
    
    /* 1. ปรับขนาดพื้นฐานของทั้งหน้า */
    body, p, span, li, a {
        font-size: 14px !important; /* ลดจากปกติที่มักจะเป็น 16px */
        line-height: 1.5; /* เพิ่มระยะห่างบรรทัดให้อ่านง่ายขึ้นในจอเล็ก */
    }

    /* 2. ปรับหัวข้อ (Headings) ไม่ให้ใหญ่คับจอ */
    h1 { font-size: 24px !important; }
    h2 { font-size: 20px !important; }
    h3 { font-size: 18px !important; }
    h4, h5, h6 { font-size: 16px !important; }

    /* 3. ปรับขนาด Input, ปุ่ม และ Form ในหน้า Admin/Login */
    input, select, textarea, button, .btn {
        font-size: 14px !important; 
        padding: 8px 12px; /* ปรับ Padding ให้กดง่ายขึ้นแต่ไม่กินที่ */
        height: auto; /* ป้องกันการกำหนดความสูงตายตัวที่อาจทำให้ตัวอักษรตก */
    }

    /* 4. ปรับตาราง (Table) ในหน้า Admin */
    /* ตารางมักจะมีปัญหาที่สุดในมือถือ ให้ลดขนาดตัวอักษรลงอีกนิด */
    table th, table td {
        font-size: 12px !important;
        padding: 5px !important;
    }
}
@media screen and (max-width: 768px) {
    /* ปรับกล่อง Login */
    .login-container, .login-box, .card {
        width: 90% !important; /* ให้กว้างเกือบเต็มจอ */
        margin: 20px auto; /* จัดกึ่งกลาง */
        padding: 15px !important; /* ลดพื้นที่ว่างด้านใน */
    }

    /* ปรับ Title ของหน้า Login */
    .login-header h1, .login-title {
        font-size: 22px !important;
        margin-bottom: 15px;
    }

    /* ปรับช่องกรอก Username/Password ให้เต็มความกว้าง */
    .login-form input {
        width: 100%;
        margin-bottom: 10px;
    }
}
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <img src="https://i.postimg.cc/yxjxZmRN/Logo-mstsc-(1)-(1).png" width="90" class="mb-3 rounded-circle border border-warning border-3">
            <h4 class="fw-bold text-dark mb-2">ADMIN REG - MSTSC</h4>
            <p class="text-muted small mb-4">สำหรับผู้ดูแลระบบคณะกรรมการสภานักเรียนเท่านั้น</p>
            <p class="text-primary small mb-4" style="font-size: 0.8rem;">
        <i class="fa-solid fa-shield-check"></i> ข้อมูลนักเรียนจะถูกจัดเก็บในระบบเป็นเวลา 5 ปีการศึกษา
    </p>
            <button onclick="loginWithGoogle()" class="btn btn-google w-100 py-2 fw-bold rounded-pill mb-3">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google">
                เข้าสู่ระบบด้วย @mst.ac.th
            </button>

            <a href="index.html" class="btn btn-link text-decoration-none text-muted small">
                <i class="fa-solid fa-arrow-left"></i> กลับหน้าหลัก
            </a>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <nav class="navbar admin-nav px-2 px-md-4 py-3 justify-content-between">
            <div class="d-flex align-items-center">
                <img src="https://i.postimg.cc/yxjxZmRN/Logo-mstsc-(1)-(1).png" class="logo">
                <div>
                    <div class="fw-bold fs-5 d-none d-md-block">ระบบจัดการข้อมูลคณะกรรมการสภานักเรียนโรงเรียนเมืองสุราษฎร์ธานี</div>
                    <div class="fw-bold fs-6 d-md-none">Admin Panel</div>
                    <small class="text-warning opacity-75" id="userEmailDisplay">Admin Mode</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-light text-primary fw-bold rounded-pill px-3 shadow-sm" title="หน้าหลัก">
                    <i class="fa-solid fa-house"></i> <span class="d-none d-md-inline">หน้าหลัก</span>
                </a>
                <button class="btn btn-warning fw-bold shadow-sm" onclick="openImportModal()" title="นำเข้าข้อมูล">
                    <i class="fa-solid fa-file-csv"></i> <span class="d-none d-md-inline">นำเข้าข้อมูลนักเรียน</span>
                </button>
                <button class="btn btn-danger fw-bold shadow-sm" onclick="openDeleteYearModal()" title="ลบข้อมูลรายปี">
    <i class="fa-solid fa-calendar-minus"></i> <span class="d-none d-md-inline">ลบข้อมูลรายปี</span>
</button>
                <button class="btn btn-info text-white fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#guideModal" title="วิธีใช้งาน">
                    <i class="fa-solid fa-circle-question"></i> <span class="d-none d-md-inline">วิธีใช้งาน</span>
                </button>
                <button class="btn btn-outline-light rounded-pill px-3 px-md-4" onclick="adminLogout()" title="ออกจากระบบ">
                    <i class="fa-solid fa-sign-out-alt"></i> <span class="d-none d-md-inline">ออกจากระบบ</span>
                </button>
            </div>
        </nav>

        <div class="container-fluid">
            
           <div id="autoDeleteAlert" class="alert alert-warning border-warning shadow-sm d-none align-items-center mb-3" role="alert">
    <i class="fa-solid fa-clock-rotate-left fs-3 me-3"></i>
    <div class="flex-grow-1">
        <strong class="text-dark">นโยบายการจัดเก็บข้อมูล:</strong> 
        <span class="text-primary fw-bold">ข้อมูลของนักเรียนทุกคนจะถูกเก็บไว้เป็นเวลา 5 ปีการศึกษา</span> 
        <br>ขณะนี้พบข้อมูลของ <span id="expiringYears" class="badge bg-danger">กำลังคำนวณ...</span> ที่ครบกำหนดแล้วและจะถูกลบอัตโนมัติ
    </div>
</div>
    
            <div class="alert alert-danger border-danger shadow-sm d-flex align-items-center mb-4" role="alert">
                <i class="fa-solid fa-shield-halved fs-2 me-3"></i>
                <div>
                    <strong class="fs-5">คำเตือน: ข้อมูลส่วนบุคคล (PDPA)</strong><br>
                    ข้อมูลในระบบนี้เป็นข้อมูลส่วนบุคคลที่มีความละเอียดอ่อน ห้ามคัดลอก เผยแพร่ หรือส่งต่อแก่บุคคลภายนอกโดยไม่ได้รับอนุญาต <br>
                    กรุณาใช้งานเพื่อการบริหารงานของสภานักเรียนโรงเรียนเมืองสุราษฎร์ธานีเท่านั้น
                </div>
            </div>

            <div class="card border-0 shadow-sm p-4 rounded-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold text-primary m-0"><i class="fa-solid fa-database"></i> ฐานข้อมูลนักเรียน</h5>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="location.reload()">
                        <i class="fa-solid fa-sync"></i> รีเฟรช
                    </button>
                </div>

                <div class="custom-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="ค้นหาด้วย ชื่อ, นามสกุล หรือชื่อเล่น...">
                </div>

                <div class="table-responsive">
                    <table id="studentTable" class="table table-hover w-100 fs-6">
                        <thead class="bg-light text-primary">
                            <tr>
                                <th>ปีการศึกษา</th> <th>รหัส</th> <th>บัตร ปชช.</th> <th>ชื่อ-สกุล (ไทย)</th>
                                <th>ชื่อเล่น</th> <th>ห้อง</th> <th>อีเมล</th> <th>เบอร์โทร</th> <th>สถานะ</th> <th>จัดการ</th>
                                <th class="d-none">ชื่อ (Eng)</th>
                                <th class="d-none">วันเกิด</th>
                                <th class="d-none">กรุ๊ปเลือด</th>
                                <th class="d-none">ไซส์เสื้อ</th>
                                <th class="d-none">อีเมลส่วนตัว</th>
                                <th class="d-none">Line ID</th>
                                <th class="d-none">Social Media</th>
                                <th class="d-none">ที่อยู่</th>
                                <th class="d-none">ผู้ปกครอง</th>
                                <th class="d-none">เบอร์ผู้ปกครอง</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="global-footer">© 2026 Student Council, Muangsuratthani School.<br>Powered by Information Technology Team</div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-file-import"></i> นำเข้าข้อมูล</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-end mb-3">
                        <div class="bg-light p-3 rounded border flex-grow-1 me-3">
                            <label class="fw-bold text-primary mb-2"><i class="fa-solid fa-calendar-check"></i> เลือกปีการศึกษา:</label>
                            <input type="number" id="importYear" class="form-control fw-bold fs-5 text-center text-primary" style="max-width: 200px;">
                        </div>
                        <button type="button" class="btn btn-outline-success h-100 py-3 fw-bold" onclick="downloadTemplate()">
                            <i class="fa-solid fa-file-arrow-down"></i> โหลดแบบฟอร์ม (CSV)
                        </button>
                    </div>
                    
                    <div class="alert alert-info small">
                        <b><i class="fa-solid fa-robot"></i> ระบบนำเข้าอัจฉริยะ (Smart Import):</b><br>
                        รองรับการก๊อปปี้จาก Excel, Sheets, CSV หรือพิมพ์เอง ขอแค่มี <b>"รหัสนักเรียน 5 หลัก"</b> และ <b>"ชื่อ-สกุล"</b>
                    </div>
                    <textarea id="importData" class="form-control font-monospace" rows="10" placeholder="ตัวอย่าง: 12345 นายสภา น่ารัก"></textarea>
                    <div class="mt-2 text-end text-muted small" id="lineCount">0 รายการ</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary px-4" onclick="processImport()">ตรวจสอบและบันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-user-pen"></i> แก้ไขข้อมูลนักเรียน</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="fullEditForm" onsubmit="saveFullEdit(event)">
                        <input type="hidden" id="e_id">
                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">1. ข้อมูลหลัก</h6>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="small text-danger fw-bold">ปีการศึกษา</label><input type="number" id="e_academic_year" class="form-control fw-bold text-primary"></div>
                                <div class="col-md-3"><label class="small text-muted">รหัสนักเรียน</label><input type="text" id="e_std_id" class="form-control fw-bold" required></div>
                                <div class="col-md-3"><label class="small text-muted">เลขบัตรปชช.</label><input type="text" id="e_id_card" class="form-control text-primary" maxlength="13"></div>
                                <div class="col-md-3"><label class="small text-muted">คำนำหน้า</label><input type="text" id="e_prefix" class="form-control"></div>
                                <div class="col-md-6"><label class="small text-muted">ชื่อ (ไทย)</label><input type="text" id="e_fname_th" class="form-control" required></div>
                                <div class="col-md-6"><label class="small text-muted">นามสกุล (ไทย)</label><input type="text" id="e_lname_th" class="form-control" required></div>
                            </div>
                        </div>
                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">2. ข้อมูลส่วนตัว</h6>
                            <div class="row g-3">
                                <div class="col-md-3"><label class="small">Name (En)</label><input type="text" id="e_fname_en" class="form-control uppercase"></div>
                                <div class="col-md-3"><label class="small">Surname (En)</label><input type="text" id="e_lname_en" class="form-control uppercase"></div>
                                <div class="col-md-2"><label class="small">ชื่อเล่น</label><input type="text" id="e_nickname" class="form-control"></div>
                                <div class="col-md-2"><label class="small">ห้อง</label><input type="text" id="e_room" class="form-control"></div>
                                <div class="col-md-2"><label class="small">วันเกิด</label><input type="date" id="e_birthdate" class="form-control"></div>
                                <div class="col-md-2"><label class="small">กรุ๊ปเลือด</label><input type="text" id="e_blood" class="form-control"></div>
                                <div class="col-md-2"><label class="small">ไซส์เสื้อ</label><input type="text" id="e_shirt" class="form-control"></div>
                            </div>
                        </div>
                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">3. การติดต่อ & ที่อยู่</h6>
                            <div class="row g-3">
                                <div class="col-md-4"><label class="small text-danger fw-bold">อีเมลโรงเรียน</label><input type="text" id="e_school_email" class="form-control"></div>
                                <div class="col-md-4"><label class="small">อีเมลส่วนตัว</label><input type="text" id="e_personal_email" class="form-control"></div>
                                <div class="col-md-4"><label class="small">เบอร์โทรศัพท์</label><input type="text" id="e_phone" class="form-control"></div>
                                <div class="col-md-4"><label class="small">Line ID</label><input type="text" id="e_line" class="form-control"></div>
                                <div class="col-md-8"><label class="small">Social</label><input type="text" id="e_social" class="form-control"></div>
                                <div class="col-12 mt-3"><label class="small fw-bold">ที่อยู่</label><input type="text" id="e_addr_no" class="form-control"></div>
                                <div class="col-md-3"><label class="small">ตำบล/แขวง</label><input type="text" id="e_district" class="form-control"></div>
                                <div class="col-md-3"><label class="small">อำเภอ/เขต</label><input type="text" id="e_amphoe" class="form-control"></div>
                                <div class="col-md-3"><label class="small">จังหวัด</label><input type="text" id="e_province" class="form-control"></div>
                                <div class="col-md-3"><label class="small">รหัสไปรษณีย์</label><input type="text" id="e_zipcode" class="form-control"></div>
                            </div>
                        </div>
                        <div class="card mb-3 p-3 border-0 shadow-sm">
                            <h6 class="text-primary fw-bold border-bottom pb-2">4. ข้อมูลผู้ปกครอง</h6>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="small">ชื่อ-สกุล ผู้ปกครอง</label><input type="text" id="e_parent_name" class="form-control"></div>
                                <div class="col-md-6"><label class="small">เบอร์โทรผู้ปกครอง</label><input type="text" id="e_parent_phone" class="form-control"></div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">ยกเลิก</button>
                            <button type="submit" class="btn btn-primary px-4 py-2"><i class="fa-solid fa-save"></i> บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header modal-header-view">
                    <h5 class="modal-title"><i class="fa-solid fa-address-card"></i> ข้อมูลนักเรียนโดยละเอียด</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="view-row"><div class="view-label">รหัสนักเรียน:</div><div class="view-val" id="v_std_id"></div></div>
                            <div class="view-row"><div class="view-label">ปีการศึกษา:</div><div class="view-val" id="v_academic_year"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อ-สกุล (ไทย):</div><div class="view-val" id="v_name_th"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อ-สกุล (Eng):</div><div class="view-val" id="v_name_en"></div></div>
                            <div class="view-row"><div class="view-label">ชื่อเล่น:</div><div class="view-val" id="v_nickname"></div></div>
                            <div class="view-row"><div class="view-label">เลขบัตร ปชช.:</div><div class="view-val" id="v_id_card"></div></div>
                            <div class="view-row"><div class="view-label">วันเกิด:</div><div class="view-val" id="v_birthdate"></div></div>
                            <div class="view-row"><div class="view-label">กรุ๊ปเลือด:</div><div class="view-val" id="v_blood"></div></div>
                            <div class="view-row"><div class="view-label">ไซส์เสื้อ:</div><div class="view-val" id="v_shirt"></div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="view-row"><div class="view-label">ห้อง:</div><div class="view-val" id="v_room"></div></div>
                            <div class="view-row"><div class="view-label">เบอร์โทร:</div><div class="view-val" id="v_phone"></div></div>
                            <div class="view-row"><div class="view-label">Email โรงเรียน:</div><div class="view-val" id="v_school_email"></div></div>
                            <div class="view-row"><div class="view-label">Email ส่วนตัว:</div><div class="view-val" id="v_personal_email"></div></div>
                            <div class="view-row"><div class="view-label">Line ID:</div><div class="view-val" id="v_line"></div></div>
                            <div class="view-row"><div class="view-label">Social:</div><div class="view-val" id="v_social"></div></div>
                            <div class="view-row"><div class="view-label">ที่อยู่:</div><div class="view-val" id="v_address"></div></div>
                            <div class="view-row"><div class="view-label">ผู้ปกครอง:</div><div class="view-val" id="v_parent_name"></div></div>
                            <div class="view-row"><div class="view-label">เบอร์ผู้ปกครอง:</div><div class="view-val" id="v_parent_phone"></div></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteYearModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-triangle-exclamation"></i> ลบข้อมูลรายปี</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="fw-bold mb-2">เลือกปีการศึกษาที่ต้องการลบ:</label>
                <select id="deleteYearSelect" class="form-select fw-bold text-danger border-danger">
                    </select>
                <div class="alert alert-warning mt-3 mb-0 small">
                    <i class="fa-solid fa-circle-info"></i> ข้อมูลนักเรียนทั้งหมดในปีที่เลือกจะถูกลบออกถาวร
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-danger" onclick="processDeleteYear()">ยืนยันการลบ</button>
            </div>
        </div>
    </div>
</div>
    
    <div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-book"></i> วิธีการใช้งานระบบ Admin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="accordionGuide">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#colGuide1">
                                <i class="fa-solid fa-file-import me-2 text-warning"></i> 1. การนำเข้าข้อมูล (Import)
                            </button>
                        </h2>
                        <div id="colGuide1" class="accordion-collapse collapse show" data-bs-parent="#accordionGuide">
                            <div class="accordion-body">
                                <ul>
                                    <li>กดปุ่ม <b>"นำเข้า"</b> สีเหลืองที่เมนู</li>
                                    <li>ระบุ <b>ปีการศึกษา</b> ที่ต้องการนำเข้า (เช่น 2567)</li>
                                    <li>เตรียมข้อมูลใน Excel หรือ Text File โดยต้องมี 2 ส่วนคือ <code>รหัสนักเรียน 5 หลัก</code> และ <code>ชื่อ-สกุล</code></li>
                                    <li>ก๊อปปี้และวางในกล่องข้อความ ระบบจะแยก "คำนำหน้า" และ "ชื่อ" ให้อัตโนมัติ (Smart Import)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colGuide2">
                                <i class="fa-solid fa-users-gear me-2 text-primary"></i> 2. การจัดการข้อมูล
                            </button>
                        </h2>
                        <div id="colGuide2" class="accordion-collapse collapse" data-bs-parent="#accordionGuide">
                            <div class="accordion-body">
                                <ul>
                                    <li><b>ค้นหา:</b> ใช้ช่องค้นหาด้านบน พิมพ์ชื่อ, นามสกุล หรือชื่อเล่น</li>
                                    <li><b>แก้ไข:</b> กดปุ่ม <i class="fa-solid fa-pen-to-square text-warning"></i> สีเหลือง เพื่อแก้ไขข้อมูลรายคน</li>
                                    <li><b>ลบ:</b> กดปุ่ม <i class="fa-solid fa-trash text-danger"></i> สีแดง เพื่อลบข้อมูล (ต้องยืนยันก่อนลบ)</li>
                                    <li><b>ดูรายละเอียด:</b> กดปุ่ม <i class="fa-solid fa-magnifying-glass text-info"></i> สีฟ้า เพื่อดูข้อมูลเชิงลึกทั้งหมด</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colGuide3">
                                <i class="fa-solid fa-file-excel me-2 text-success"></i> 3. การส่งออกข้อมูล (Export)
                            </button>
                        </h2>
                        <div id="colGuide3" class="accordion-collapse collapse" data-bs-parent="#accordionGuide">
                            <div class="accordion-body">
                                <ul>
                                    <li>กดปุ่ม <b>"Export All (Excel)"</b> สีเขียวเหนือตาราง</li>
                                    <li>ระบบจะดาวน์โหลดไฟล์ <code>.xlsx</code> ที่มีข้อมูลครบทุกช่อง (รวมถึงช่องที่ซ่อนอยู่ เช่น ชื่ออังกฤษ, ผู้ปกครอง)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
    <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colGuide4">
            <i class="fa-solid fa-calendar-minus me-2 text-danger"></i> 4. การลบข้อมูลรายปี (Delete by Year)
        </button>
    </h2>
    <div id="colGuide4" class="accordion-collapse collapse" data-bs-parent="#accordionGuide">
        <div class="accordion-body">
            <div class="p-2 mb-3 bg-light border-start border-4 border-info rounded">
                <i class="fa-solid fa-info-circle text-info"></i> <b>นโยบายระบบ:</b> ข้อมูลของนักเรียนทุกคนจะถูกเก็บไว้ในระบบเป็นเวลา <b>5 ปีการศึกษา</b> และจะมีการทำความสะอาดข้อมูลเก่าโดยอัตโนมัติ
            </div>
            
            <ul class="mb-0">
                <li>กดปุ่ม <b>"ลบข้อมูลรายปี"</b> เพื่อลบปีที่ต้องการด้วยตนเอง</li>
                <li>พิมพ์รหัสยืนยันเพื่อความปลอดภัยก่อนลบข้อมูลถาวร</li>
            </ul>
        </div>
    </div>
</div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://llbazqwparjaptsjbxxp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsYmF6cXdwYXJqYXB0c2pieHhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDk0MDQsImV4cCI6MjA4NDU4NTQwNH0.NcHwvFMnzU6GgHBaud4nNJgwFBK1WQtxAdGbcM-BaYU';
        const db = createClient(supabaseUrl, supabaseKey);
        
        // รายชื่ออีเมลที่อนุญาตให้เข้าใช้งาน
        const ALLOWED_EMAILS = [
    'studentcouncil@mst.ac.th',
    '6829903@mst.ac.th',
    'tassanee@mst.ac.th',
    'admin.it@mst.ac.th' 
    // เพิ่มได้เรื่อยๆ ครับ
        ];
    

        // ================= AUTHENTICATION LOGIC (NEW) =================
        $(document).ready(async () => {
            // เช็คว่ามี Session ค้างอยู่ไหม
            const { data: { session } } = await db.auth.getSession();
            
            if (session) {
                checkUserAndRedirect(session.user);
            } else {
                $('#login-overlay').show(); // แสดงหน้า Login
            }

            // ฟัง Event เมื่อมีการล็อกอินกลับมาจาก Google
            db.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    checkUserAndRedirect(session.user);
                } else if (event === 'SIGNED_OUT') {
                    $('#admin-content').hide();
                    $('#login-overlay').fadeIn();
                }
            });
        });

        // ฟังก์ชันล็อกอินด้วย Google
        // ฟังก์ชันล็อกอินด้วย Google (ปรับปรุงใหม่)
        async function loginWithGoogle() {
            const { data, error } = await db.auth.signInWithOAuth({
                provider: 'google',
                options: { 
                    queryParams: { access_type: 'offline', prompt: 'consent' },
                    // บรรทัดนี้สำคัญ! สั่งให้เด้งกลับมาที่หน้าปัจจุบัน (admin.html) ไม่ใช่หน้า index
                    redirectTo: window.location.href 
                }
            });
            if (error) Swal.fire('Error', error.message, 'error');
        }

        // ฟังก์ชันตรวจสอบอีเมล (รองรับหลายคน)
        function checkUserAndRedirect(user) {
            const email = user.email;
            
            // เช็คว่าอีเมลของคนที่ล็อกอิน มีอยู่ในรายการ ALLOWED_EMAILS หรือไม่
            if (ALLOWED_EMAILS.includes(email)) {
                // อีเมลถูกต้อง -> เข้าสู่ระบบ
                $('#userEmailDisplay').text(email);
                $('#login-overlay').fadeOut();
                $('#admin-content').fadeIn();
                initTable();
            } else {
                // อีเมลผิด -> แจ้งเตือนและดีดออก
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่ได้',
                    html: `อีเมล <b>${email}</b> ไม่มีสิทธิ์เข้าถึงระบบ Admin`,
                    confirmButtonText: 'ตกลง',
                    allowOutsideClick: false
                }).then(() => {
                    db.auth.signOut();
                });
            }
        }

        async function adminLogout() {
            const { error } = await db.auth.signOut();
            if(!error) location.reload();
        }
        // ================= END AUTH =================

        // TABLE
        let table;
        async function initTable() {
            if ($.fn.DataTable.isDataTable('#studentTable')) return;
            if ($.fn.DataTable.isDataTable('#studentTable')) {
        return; 
    }
            const { data, error } = await db.from('student_council').select('*').order('std_id', { ascending: true });
            if(error) return console.error(error);

            table = $('#studentTable').DataTable({
                data: data,
                columns: [
                    { data: 'academic_year', render: d => d ? `<span class="badge bg-secondary">${d}</span>` : '-' },
                    { data: 'std_id' },
                    { data: 'id_card', defaultContent: '-' },
                    { data: null, render: d => `${d.prefix||''} ${d.fname_th} ${d.lname_th}` },
                    { data: 'nickname', defaultContent: '-' },
                    { data: 'room', render: d => d ? `ห้อง ${d}` : '-' },
                    { data: 'school_email', defaultContent: '-' },
                    { data: 'phone', defaultContent: '-' },
                    { data: 'id_card', render: d => (d && d.length>5) ? '<span class="status-badge bg-active">Active</span>':'<span class="status-badge bg-inactive">New</span>' },
                    {
                        data: null, className: "text-center",
                        render: (d, t, r) => {
                            const row = encodeURIComponent(JSON.stringify(r));
                            return `
                                <button class="btn btn-info btn-sm text-white" onclick="openView('${row}')" title="ดูข้อมูล"><i class="fa-solid fa-magnifying-glass"></i></button>
                                <button class="btn btn-warning btn-sm" onclick="openEdit('${row}')" title="แก้ไข"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteStudent('${r.id}')" title="ลบ"><i class="fa-solid fa-trash"></i></button>
                            `;
                        }
                    },
                    { data: null, visible: false, render: d => `${d.fname_en} ${d.lname_en}` },
                    { data: 'birthdate', visible: false }, 
                    { data: 'blood_type', visible: false },
                    { data: 'shirt_size', visible: false }, 
                    { data: 'personal_email', visible: false },
                    { data: 'line_id', visible: false }, 
                    { data: 'social', visible: false },
                    { data: 'addr_no', visible: false }, 
                    { data: 'parent_name', visible: false },
                    { data: 'parent_phone', visible: false }
                ],
                dom: 'lBrtip', 
                lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "ทั้งหมด"]],
                language: {
                    lengthMenu: "แสดง _MENU_ รายการ",
                    info: "แสดง _START_ ถึง _END_ จากทั้งหมด _TOTAL_ รายการ",
                    paginate: { first: "หน้าแรก", last: "หน้าสุดท้าย", next: "ถัดไป", previous: "ก่อนหน้า" },
                    emptyTable: "ไม่มีข้อมูลในตาราง"
                },
                buttons: [{ 
                    extend: 'excelHtml5', 
                    text: '<i class="fa-solid fa-file-excel"></i> Export All (Excel)', 
                    className: 'btn btn-success mb-3 ms-2', 
                    exportOptions: { 
                        columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
                        format: {
                            header: function (data, columnIdx) {
                                const headers = [
                                    "ปีการศึกษา", "รหัสนักเรียน", "เลขบัตรประชาชน", "ชื่อ-สกุล (ไทย)", "ชื่อเล่น", "ห้อง",
                                    "อีเมลโรงเรียน", "เบอร์โทรศัพท์", "สถานะ", "จัดการ", "ชื่อ-สกุล (อังกฤษ)", "วันเกิด",
                                    "กรุ๊ปเลือด", "ไซส์เสื้อ", "อีเมลส่วนตัว", "Line ID", "Social Media", "ที่อยู่",
                                    "ชื่อผู้ปกครอง", "เบอร์ผู้ปกครอง"
                                ];
                                return headers[columnIdx] || data;
                            }
                        }
                    }
                }],
                pageLength: 20
            });
            async function checkExpiringData() {
    const currentYearTH = new Date().getFullYear() + 543;
    const expiryThreshold = currentYearTH - 5; // เกณฑ์ 5 ปี

    // ดึงรายการปีการศึกษาที่มีอยู่ในระบบมาตรวจสอบ
    const { data, error } = await db
        .from('student_council')
        .select('academic_year')
        .lte('academic_year', expiryThreshold); // กรองเอาเฉพาะปีที่เก่ากว่าหรือเท่ากับเกณฑ์

    if (data && data.length > 0) {
        // หาปีที่เก่าที่สุดและใหม่ที่สุดที่จะโดนลบ
        const years = [...new Set(data.map(item => item.academic_year))].sort();
        
        if (years.length > 0) {
            $('#expiringYears').text('ปีการศึกษา ' + years.join(', '));
            $('#autoDeleteAlert').removeClass('d-none').addClass('d-flex');
        }
    }
}

// เรียกใช้งานฟังก์ชัน
$(document).ready(function() {
    // รอให้ตารางโหลดเสร็จก่อนค่อยเช็ค (หรือเรียกต่อจาก initTable)
    setTimeout(checkExpiringData, 2000);
});
            $('#searchInput').on('keyup', function() { table.search(this.value).draw(); });
        }

        // Functions for Import/Edit/Delete (Same as before)
        function downloadTemplate() {
            const csvContent = "\uFEFFstd_id,full_name\n12345,นายสมชาย ใจดี\n12346,นางสาวสมหญิง รักเรียน";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "template_student_import.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openImportModal() {
            const today = new Date();
            let defaultYear = today.getFullYear() + 543;
            if (today.getMonth() < 4 || (today.getMonth() === 4 && today.getDate() < 15)) defaultYear -= 1;
            $('#importYear').val(defaultYear);
            new bootstrap.Modal('#importModal').show();
        }

        $('#importData').on('input', function() { $('#lineCount').text($(this).val().trim().split('\n').filter(l=>l.trim()).length + ' รายการ'); });

        function splitThaiName(fullName) {
            fullName = fullName.trim();
            const prefixes = ["นางสาว", "นาง", "นาย", "ด.ช.", "ด.ญ.", "ว่าที่ร้อยตรี", "น.ส.", "น.ส", "เด็กชาย", "เด็กหญิง"];
            let prefix = "", fname = "", lname = "";
            for (let p of prefixes) {
                if (fullName.startsWith(p)) {
                    prefix = (p === "น.ส." || p === "น.ส") ? "นางสาว" : p;
                    fullName = fullName.substring(p.length).trim();
                    break;
                }
            }
            const parts = fullName.split(/\s+/);
            if (parts.length > 0) fname = parts[0];
            if (parts.length > 1) lname = parts.slice(1).join(" ");
            return { prefix, fname, lname };
        }

        async function processImport() {
            const raw = $('#importData').val().trim();
            const selectedYear = $('#importYear').val();
            if(!selectedYear) return Swal.fire('ระบุปี', 'กรุณาระบุปีการศึกษา', 'warning');
            if(!raw) return Swal.fire('ข้อมูลว่าง', 'กรุณาวางข้อมูลนักเรียน', 'warning');

            const lines = raw.split('\n');
            const candidates = []; const candidateIds = [];
            let invalidLines = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                const idMatch = line.match(/(\d{5})/);
                if (idMatch) {
                    const stdId = idMatch[0];
                    let namePart = line.replace(stdId, '').trim();
                    namePart = namePart.replace(/^[,;\t-]+|[,;\t-]+$/g, '').trim();
                    if (namePart) {
                        const nameObj = splitThaiName(namePart);
                        if (nameObj.fname) {
                            candidates.push({ std_id: stdId, prefix: nameObj.prefix, fname_th: nameObj.fname, lname_th: nameObj.lname, academic_year: selectedYear });
                            candidateIds.push(stdId);
                        } else invalidLines++;
                    } else invalidLines++;
                } else invalidLines++;
            });

            if(candidates.length === 0) return Swal.fire('ไม่พบข้อมูล', 'โปรดตรวจสอบรูปแบบข้อมูล (ต้องมีรหัส 5 หลัก)', 'error');
            Swal.fire({ title: 'กำลังตรวจสอบ...', didOpen: () => Swal.showLoading() });

            const { data: existingRecords } = await db.from('student_council').select('std_id').in('std_id', candidateIds);
            const existingSet = new Set(existingRecords ? existingRecords.map(r => r.std_id) : []);
            
            const finalInsert = candidates.filter(c => !existingSet.has(c.std_id));
            const skippedCount = candidates.length - finalInsert.length;

            if (finalInsert.length === 0) return Swal.fire('ข้อมูลซ้ำทั้งหมด', `มี ${skippedCount} รายการซ้ำในระบบแล้ว`, 'info');

            const confirm = await Swal.fire({ 
                title: `ยืนยันนำเข้า`, 
                html: `ปีการศึกษา: <b>${selectedYear}</b><br>ข้อมูลใหม่: <b class="text-success">${finalInsert.length}</b><br>ซ้ำ/ข้าม: <b class="text-danger">${skippedCount}</b>` + (invalidLines > 0 ? `<br>อ่านไม่ออก: ${invalidLines}` : ''),
                icon: 'question', showCancelButton: true, confirmButtonText: 'ยืนยันนำเข้า' 
            });
            
            if (!confirm.isConfirmed) return;

            const { error: insertError } = await db.from('student_council').insert(finalInsert);
            if(insertError) Swal.fire('บันทึกไม่สำเร็จ', insertError.message, 'error');
            else { Swal.fire('สำเร็จ', `บันทึก ${finalInsert.length} รายการ`, 'success'); $('#importModal').modal('hide'); location.reload(); }
        }

        window.openView = function(encodedRow) {
            const r = JSON.parse(decodeURIComponent(encodedRow));
            $('#v_std_id').text(r.std_id || '-'); $('#v_academic_year').text(r.academic_year || '-');
            $('#v_name_th').text(`${r.prefix || ''} ${r.fname_th} ${r.lname_th}`); $('#v_name_en').text(`${r.fname_en || ''} ${r.lname_en || ''}`);
            $('#v_nickname').text(r.nickname || '-'); $('#v_id_card').text(r.id_card || '-');
            $('#v_birthdate').text(r.birthdate || '-'); $('#v_blood').text(r.blood_type || '-');
            $('#v_shirt').text(r.shirt_size || '-'); $('#v_room').text(r.room ? `ห้อง ${r.room}` : '-');
            $('#v_phone').text(r.phone || '-'); $('#v_school_email').text(r.school_email || '-');
            $('#v_personal_email').text(r.personal_email || '-'); $('#v_line').text(r.line_id || '-');
            $('#v_social').text(r.social || '-'); $('#v_address').text(`${r.addr_no||''} ${r.district||''} ${r.amphoe||''} ${r.province||''} ${r.zipcode||''}`);
            $('#v_parent_name').text(r.parent_name || '-'); $('#v_parent_phone').text(r.parent_phone || '-');
            new bootstrap.Modal('#viewModal').show();
        }

        window.openEdit = function(encodedRow) {
            const r = JSON.parse(decodeURIComponent(encodedRow));
            $('#e_id').val(r.id); $('#e_academic_year').val(r.academic_year); 
            $('#e_std_id').val(r.std_id); $('#e_id_card').val(r.id_card);
            $('#e_prefix').val(r.prefix); $('#e_fname_th').val(r.fname_th); $('#e_lname_th').val(r.lname_th);
            $('#e_fname_en').val(r.fname_en); $('#e_lname_en').val(r.lname_en); $('#e_nickname').val(r.nickname);
            $('#e_room').val(r.room); $('#e_birthdate').val(r.birthdate); $('#e_blood').val(r.blood_type); $('#e_shirt').val(r.shirt_size);
            $('#e_school_email').val(r.school_email); $('#e_personal_email').val(r.personal_email);
            $('#e_phone').val(r.phone); $('#e_line').val(r.line_id); $('#e_social').val(r.social);
            $('#e_addr_no').val(r.addr_no); $('#e_district').val(r.district); $('#e_amphoe').val(r.amphoe);
            $('#e_province').val(r.province); $('#e_zipcode').val(r.zipcode);
            $('#e_parent_name').val(r.parent_name); $('#e_parent_phone').val(r.parent_phone);
            new bootstrap.Modal('#editModal').show();
        }

        async function saveFullEdit(e) {
            e.preventDefault();
            const id = $('#e_id').val();
            const updateObj = {
                academic_year: $('#e_academic_year').val(), std_id: $('#e_std_id').val(), id_card: $('#e_id_card').val(),
                prefix: $('#e_prefix').val(), fname_th: $('#e_fname_th').val(), lname_th: $('#e_lname_th').val(),
                fname_en: $('#e_fname_en').val().toUpperCase(), lname_en: $('#e_lname_en').val().toUpperCase(),
                nickname: $('#e_nickname').val(), room: $('#e_room').val(), birthdate: $('#e_birthdate').val(),
                blood_type: $('#e_blood').val(), shirt_size: $('#e_shirt').val(),
                school_email: $('#e_school_email').val(), personal_email: $('#e_personal_email').val(),
                phone: $('#e_phone').val(), line_id: $('#e_line').val(), social: $('#e_social').val(),
                addr_no: $('#e_addr_no').val(), district: $('#e_district').val(), amphoe: $('#e_amphoe').val(),
                province: $('#e_province').val(), zipcode: $('#e_zipcode').val(),
                parent_name: $('#e_parent_name').val(), parent_phone: $('#e_parent_phone').val()
            };
            const { error } = await db.from('student_council').update(updateObj).eq('id', id);
            if(error) Swal.fire('Error', error.message, 'error');
            else { Swal.fire('Saved', 'บันทึกสำเร็จ', 'success'); location.reload(); }
        }

        window.deleteStudent = async function(id) {
            const res = await Swal.fire({title:'ยืนยันลบ?', text:'ข้อมูลจะหายไปถาวร', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'ลบเลย'});
            if(res.isConfirmed) {
                const { error } = await db.from('student_council').delete().eq('id', id);
                if(error) Swal.fire('ลบไม่ได้', 'ตรวจสอบ Policy', 'error');
                else { Swal.fire('เรียบร้อย', 'ลบข้อมูลแล้ว', 'success'); setTimeout(() => location.reload(), 1000); }
            }
        }
        // ฟังก์ชันเปิด Modal และดึงรายการปีที่มีอยู่ในระบบมาแสดงใน Dropdown
async function openDeleteYearModal() {
    // ดึงปีการศึกษาที่ไม่ซ้ำกัน (Distinct) จาก Database
    const { data, error } = await db.from('student_council').select('academic_year');
    
    if (error) return Swal.fire('Error', 'ไม่สามารถดึงข้อมูลปีการศึกษาได้', 'error');

    // กรองเอาเฉพาะปีที่ไม่ซ้ำ และเรียงจากมากไปน้อย
    const years = [...new Set(data.map(item => item.academic_year))].sort((a, b) => b - a);
    
    const select = $('#deleteYearSelect');
    select.empty();
    
    if (years.length === 0 || (years.length === 1 && years[0] === null)) {
        select.append('<option value="">-- ไม่มีข้อมูล --</option>');
    } else {
        years.forEach(year => {
            if(year) select.append(`<option value="${year}">ปีการศึกษา ${year}</option>`);
        });
    }
    
    new bootstrap.Modal('#deleteYearModal').show();
}

// ฟังก์ชันดำเนินการลบข้อมูลทั้งปี
async function processDeleteYear() {
    const year = $('#deleteYearSelect').val();
    if (!year) return Swal.fire('แจ้งเตือน', 'ไม่มีปีการศึกษาให้ลบ', 'warning');

    // ยืนยันขั้นที่ 1
    const confirm1 = await Swal.fire({
        title: `ยืนยันลบข้อมูลปี ${year}?`,
        text: `นักเรียนทุกคนในปีการศึกษา ${year} จะถูกลบออกจากฐานข้อมูล`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'ใช่, ฉันแน่ใจ',
        cancelButtonText: 'ยกเลิก'
    });

    if (!confirm1.isConfirmed) return;

    // --- ส่วนที่แก้ไข: ปิด Modal เดิมก่อนเพื่อไม่ให้มันบล็อกการพิมพ์ ---
    $('#deleteYearModal').modal('hide'); 

    // ยืนยันขั้นที่ 2
    const { value: confirmText } = await Swal.fire({
        title: 'ยืนยันความปลอดภัย',
        html: `กรุณาพิมพ์คำว่า <b class="text-danger">${year}</b> เพื่อยืนยันการลบข้อมูลทั้งหมด`,
        input: 'text',
        inputPlaceholder: `${year}`,
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'ลบทิ้งถาวร!',
        cancelButtonText: 'ยกเลิก',
        allowOutsideClick: false,
        didOpen: () => {
            // สั่งให้ Focus ไปที่ช่องพิมพ์ทันทีเมื่อเปิดขึ้นมา
            const input = Swal.getInput();
            if (input) input.focus();
        }
    });

    if (confirmText === `${year}`) {
        Swal.fire({ title: 'กำลังลบข้อมูล...', didOpen: () => Swal.showLoading() });
        
        const { error } = await db.from('student_council').delete().eq('academic_year', year);
        
        if (error) {
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้: ' + error.message, 'error');
        } else {
            Swal.fire('สำเร็จ', `ลบข้อมูลปีการศึกษา ${year} เรียบร้อยแล้ว`, 'success')
            .then(() => location.reload());
        }
    } else if (confirmText !== undefined) {
        Swal.fire('ข้อมูลไม่ถูกต้อง', 'รหัสยืนยันไม่ตรงกัน ข้อมูลจึงไม่ถูกลบ', 'error');
    }
}
    </script>
</body>
</html>